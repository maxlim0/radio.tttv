<?php	require 'DB.php';//$rp_pass = UTF8::substr(md5(time() . $_SERVER['REMOTE_ADDR']), 3, 10);	if(isset($_POST['pass'])){		$hp = $_POST['pass'];		if ($hp != ''){$hp = md5(md5(trim($_POST['pass'])));}	}	if(isset($_POST['login'])){$login = trim($_POST['login']);  if ($login == ''){unset($login);}}	if(isset($_POST['cl_name'])){$cl_name = trim($_POST['cl_name']);  if ($cl_name == ''){unset($cl_name);}}	if(isset($_POST['cl_mail'])){$cl_mail = trim($_POST['cl_mail']);  if ($cl_mail == ''){unset($cl_mail);}}	if(isset($_POST['cl_fio'])){$cl_fio = $_POST['cl_fio'];}	if(isset($_POST['cl_phone'])){$cl_phone = $_POST['cl_phone'];}	if(isset($_POST['cl_pass'])){		$cl_upass = trim($_POST['cl_pass']);		$cl_pass = md5(md5(trim($_POST['cl_pass'])));  		if ($cl_pass == ''){unset($cl_pass);}}	if(isset($_POST['closed_c'])){$closed_c = intval($_POST['closed_c']);} 	if(isset($_POST['out'])){$out = trim($_POST['out']);} 	if(isset($_POST['key'])){$id_news = intval($_POST['key']);} 	if(isset($_POST['users_id'])){$users_id = intval($_POST['users_id']);} 	if(isset($_POST['del'])){$del = intval($_POST['del']);} 	class userAuth {	public $db_user_table = 'users';	public $db_board_table = 'board';	public $db_guest_table = 'guest';	public  static $DB;	public function __construct() {		self::$DB = new DB();		session_start();	}	public function __destruct() {		self::$DB->close();	}	 function Auth($login,$passw,$closed_c) {	 $ses = md5(time());	 $dat_ses = date('Y-m-d H:i:s');	 $login = self::$DB->escape($login);	 $pass = self::$DB->escape($pass);				$sql = "SELECT name, ses, role FROM $this->db_user_table WHERE name='$login'";				$qw=self::$DB->query($sql);				if(self::$DB->num_rows($qw)>0) {//user exist					$re = self::$DB->fetch_array($qw);					if($re['ses']!='0'&&$re['role']!=1){						return 	 '-95';					}				}		 if($closed_c == 1){			$sql = "SELECT id,name,role,closed FROM $this->db_user_table WHERE name='$login'&&pass='$passw' ";			$qw=self::$DB->query($sql);			if (self::$DB->num_rows($qw)>0) {				$re = self::$DB->fetch_array($qw);					if ((isset($re['name'])&&$re['closed']==1)||$re['role']==1) {							$_SESSION['user_chat'] 		= $login;							$_SESSION['user_role_chat']	= $re['role'];							$sql = "UPDATE $this->db_user_table SET ses ='$ses',dat_ses='$dat_ses' 							WHERE id='$re[id]' ";							$qw=self::$DB->query($sql);							$_SESSION['new_ses']	= $ses;							$error = 1;						}else{						$error = '-100';					} 				}else{				$error = '-2';			}		}else{			if($closed_c == 3){				$sql = "SELECT id,role,name FROM $this->db_user_table WHERE name='$login'&&pass='$passw' ";				$qw=self::$DB->query($sql);				if (self::$DB->num_rows($qw)>0) {//user exist					$re = self::$DB->fetch_array($qw);					if($re['role'] ==1){						$_SESSION['user_chat'] 		= $re['name'];						$_SESSION['user_role_chat']	= $re['role'];						$sql = "UPDATE $this->db_user_table 										SET ses ='$ses',dat_ses='$dat_ses' 										WHERE id='$re[id]' ";						$qw=self::$DB->query($sql);						return 1;					}else{						return '-98';					}				}else{					return '-97';				}			}					if($login!=''){//Full open chat				$_SESSION['user_chat'] = $login;				$sql = "SELECT id,name,ses,role FROM $this->db_user_table WHERE name='$login' ";				$qw=self::$DB->query($sql);				if (self::$DB->num_rows($qw)>0) {//user exist					$re = self::$DB->fetch_array($qw);					$id = $re['id'];					if($re['ses']==0||$re['role']==1){//session = 0							$sql = "UPDATE $this->db_user_table SET ses ='$ses',dat_ses='$dat_ses' WHERE id='$id' ";							$qw=self::$DB->query($sql);							if($re['role']==1){							$sql = "SELECT id FROM $this->db_user_table WHERE name='$login'&&pass='$passw' ";							$qw=self::$DB->query($sql);								if (self::$DB->num_rows($qw)>0){									$_SESSION['user_role_chat']	= $re['role'];									$error = 1;								}else{									$error = '-99';								}							}else{								$_SESSION['user_role_chat']	= $re['role']; //guest user								$error = 1;							}						}else{						$error = '-101';//session exist 					}					}else{//New user full open chat					$sql = "INSERT INTO $this->db_user_table (name,ses,dat_ses,role) VALUES ('$login','$ses','$dat_ses','3')";					$qw=self::$DB->query($sql);					$_SESSION['user_role_chat']	= 3; //guest user					$_SESSION['new_ses']	= $ses;					$error = 1;				}					if($passw!=''){					$sql = "SELECT id,name,role 											FROM $this->db_user_table 											WHERE name='$login'&&pass='$passw' ";					$qw=self::$DB->query($sql);					if (self::$DB->num_rows($qw)>0) {						$re = self::$DB->fetch_array($qw);						$_SESSION['user_chat'] 		= $re['name'];						$_SESSION['user_role_chat']	= $re['role'];						$sql = "UPDATE $this->db_user_table SET ses ='$ses',dat_ses='$dat_ses' 							WHERE id='$re[id]' ";						$qw=self::$DB->query($sql);						$error = 1;					}else{						$error = "-102";					}									}							}else{				$error ='-103';			}					}		return $error;	}		function AuthRegistrtion($cl_name,$cl_phone,$cl_pass,$cl_mail,$cl_role,$cl_fio,$cl_upass){			$cl_name = self::$DB->escape($cl_name);			$cl_pass = self::$DB->escape($cl_pass);			$cl_mail = self::$DB->escape($cl_mail);			$cl_fio = self::$DB->escape($cl_fio);			$cl_upass = self::$DB->escape($cl_upass);			$cl_phone = self::$DB->escape($cl_phone);			$sql = "SELECT name FROM $this->db_user_table WHERE name='$cl_name' ";			$qw=self::$DB->query($sql);			if (self::$DB->num_rows($qw)>0) {				return '-2';			}						$dat_reg = date('Y-m-d H:i:s');			$sql = "INSERT INTO $this->db_user_table (name,fio,phone,pass,upass,mail,dat_reg,role) 							VALUES ('$cl_name','$cl_fio',$cl_phone,'$cl_pass','$cl_upass','$cl_mail','$dat_reg','$cl_role')";			$qw=self::$DB->query($sql);			if($sql==true){				$this->OutMailRegistration($cl_fio,$cl_mail,$cl_name,$cl_upass);				return 1;				}else{					return '-1';			}	}			function CheckSession($user,$role){				$dat_ses = date('Y-m-d H:i:s');				$sql = "SELECT ses FROM $this->db_user_table WHERE name='$user' ";				$qw=self::$DB->query($sql);				if (self::$DB->num_rows($qw)>0) {					$re = self::$DB->fetch_array($qw);					$ses = $re['ses'];				}else{					return '-1';				}				if($role==1){					return 1;				}				if($role==2||$role==3){					if($re['ses']!=0){						return	1;						}else{							if($_SESSION['new_ses']){										$ses = $_SESSION['new_ses'];										$sql = "UPDATE $this->db_user_table SET ses ='$ses',dat_ses='$dat_ses'															WHERE id='$id' ";										$qw=self::$DB->query($sql);										return	1;										}else{												return	'-100';															}					}								}					return '-101';		}					function DelSession($user){			$sql = "UPDATE $this->db_user_table SET ses ='0' WHERE name='$user'  ";			$qw=self::$DB->query($sql);				unset($_SESSION['user_chat']);				unset($_SESSION['user_role_chat']);			if($sql==true){					return 1;				}else{					return '-1';			}	}										function Auth_out() {		unset($_SESSION['user_chat']);		unset($_SESSION['user_role_chat']);	}	function OutMailRegistration($fio,$mail,$login,$pass){			$subject = 'Регистрация в Invest Club';// тема письма			$subject = "=?utf-8?b?" .base64_encode($subject). "?="; 			$headers  = 'MIME-Version: 1.0' . "\r\n";			$headers .= 'Content-type: text/html; charset=utf-8' . "\r\n";			$headers .= "From: Site Invest Club <info@teletrade.tv>\r\n";				$message = "			<html>			<head>			<meta http-equiv='Content-Type' content='text/html; charset=utf-8' />			</head>			<body>			<hr>			Здравствуйте $fio			<br>			Вы прошли регистрацию в Invest Club.			<br />			Ваши данные входа:			<br />			Логин: $login			<br />			Пароль: $pass			<br />			Если Вы не регистрировались, сообщите нам на e-mail: info@teletrade.tv			<hr>						<body>			</html>			";		return mail($mail, $subject, $message, $headers);	}}	$auth = new userAuth();		if(isset($login)&&isset($hp)){		echo $auth->Auth($login,$hp,$closed_c);	}	if(isset($cl_name)&&isset($cl_pass)&&isset($cl_mail)){		echo $auth->AuthRegistrtion($cl_name,$cl_phone,$cl_pass,$cl_mail,'2',$cl_fio,$cl_upass);	}		if(isset($out)){		echo $auth->Auth_out();	}unset($auth);?>